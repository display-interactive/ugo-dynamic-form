<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../chosen-decorator/chosen-decorator.html">

<dom-module id="ugo-dynamic-form">
    <template>
        <template id="fieldsContainer" is="dom-repeat" items="{{ fields }}" index-as="id">
            <div class$="[[ classes.container ]]">
                <label for$="[[ item.name ]]" class$="[[ classes.label ]]">[[item.label]]</label>
                <div class$="[[ classes.inputContainer ]]">
                    <input type$="[[ item.type ]]" class$="[[ classes.input ]]" id$="[[ item.name ]]" value="{{ item.value }}" />

                    <template is="dom-if" if="{{ !item.mandatory }}">
                        <span class$="[[ classes.removeContainer ]]">
                            <button type="button" data-id$="[[ item.name ]]" on-tap="removeField" class$="[[ classes.remove ]]">{{ texts.remove }}</button>
                        </span>
                    </template>
                </div>
            </div>
        </template>
        <chosen-decorator width="200">
            <select id="fieldType">
                <template id="selectOption" is="dom-repeat" items="{{selectOptions}}" as="option" index-as="id">
                    <option value="[[option.value]]">[[option.label]]</option>
                </template>
            </select>
        </chosen-decorator>
        <button type="button" class$="[[ classes.add ]]" on-tap="addField">{{texts.add}}</button>
    </template>
</dom-module>
<script>
    Polymer({
        is: 'ugo-dynamic-form',

        properties: {
            /**
             * Required
             */
            selector: {
                type: String
            },

            classes: {
                type: Object,
                value: {
                    container: 'form-group',
                    label: 'col-md-2 control-label',
                    inputContainer: 'col-md-10',
                    input: 'form-control',
                    remove: 'btn btn-default btn-danger',
                    add: 'btn btn-default btn-success'
                }
            },

            texts: {
                type: Object,
                value: {
                    add: '+',
                    remove: '-'
                }
            },

            /**
             * Internal
             */
            fields: {
                type: Array,
                value: [],
                readOnly: true
            },

            /**
             * Internal
             */
            selectOptions: {
                type: Array,
                value: [],
                readOnly: true
            },

            /**
             * Internal
             */
            data: {
                type: Object,
                value: {}
            }
        },

        listeners: {
            'dom-change': 'fetchData',
            'change': 'fetchData',
            'keyup': 'fetchData'
        },

        /**
         *
         */
        ready: function() {
            this.element = document.querySelector(this.selector);
            this.data = JSON.parse(this.element.value);

            this._buildFields();
        },

        /**
         * Remove a field from the form
         */
        removeField: function(event) {
            var id = event.target.getAttribute('data-id');

            for(var index = 0; index < this.fields.length; index++) {
                if (this.fields[index].name == id && !this.fields[index].mandatory) {
                    this.splice('fields', index, 1);
                    break;
                }
            }

            this._buildSelectOptions();
        },


        /**
         * Add a field to the form
         */
        addField: function() {
            var key = this.$.fieldType.value;

            var newField = {
                name: key,
                label: this._getConfig('label', key),
                value: null,
                type: this._getConfig('type', key),
                mandatory: this._getConfig('mandatory', key)
            };

            this.push('fields', newField);
            this._buildSelectOptions();
        },

        /**
         * Fetch Data from the displayed fields
         */
        fetchData: function() {
            var children = Polymer.dom(this.root).querySelectorAll('.'+this.classes.container);

            var data = {};
            [].forEach.call(children, function(element) {
                var field = Polymer.dom(element).querySelector('input');
                data[field.id] = field.value;
            });

            data.config = this.data.config;

            this.element.value = JSON.stringify(data);
        },

        /**
         * Build fields array for template
         */
        _buildFields: function () {
            var key,
                fields = [],
                rendered = [];

            //display preset data
            for (key in this.data) {
                if (this.data.hasOwnProperty(key) && key !== 'config') {
                    rendered.push(key);
                    fields.push({
                        name: key,
                        label: this._getConfig('label', key),
                        value: this.data[key],
                        type: this._getConfig('type', key),
                        mandatory: this._getConfig('mandatory', key)
                    });
                }
            }

            //display mandatory field with no preset data
            if (this.data.config != undefined) {
                for (key in this.data.config) {
                    if  (
                        this.data.config.hasOwnProperty(key)
                        && this.data.config[key].mandatory
                        && rendered.indexOf(key) == -1
                    ) {
                        rendered.push(key);
                        fields.push({
                            name: key,
                            label: this._getConfig('label', key),
                            value: "",
                            type: this._getConfig('type', key),
                            mandatory: true
                        })
                    }
                }
            }

            this._setFields(fields);
            this._buildSelectOptions();
        },

        /**
         * build select options
         *
         * depends from fields
         */
        _buildSelectOptions: function() {
            var options = [], key;
            if (this.data.config != undefined) {
                for (key in this.data.config) {
                    if (this.data.config.hasOwnProperty(key) && !this._inField(key)) {
                        options.push({
                            value: key,
                            label: this._getConfig('label', key)
                        })
                    }
                }
            }

            this._setSelectOptions(options);
        },

        /**
         * Get config
         * @param {String} type
         * @param {String} key
         * @private
         */
        _getConfig: function(type, key) {
            if (
                this.data.config != undefined
                && this.data.config[key] != undefined
                && this.data.config[key][type] != undefined
            ) {
                return this.data.config[key][type];
            }

            var defaultValue = null;
            switch (type) {
                case 'type':
                    defaultValue = 'text';
                    break;
                case 'mandatory': //if not config specified then it's not mandatory
                    defaultValue = false;
                    break;
                case 'label':
                    defaultValue = key;
                    break;
            }

            return defaultValue;
        },

        /**
         * @param {String} name
         * @return {Boolean}
         */
        _inField: function(name) {
            var key;
            /** @var {Array} this.fields */
            for (key in this.fields) {
                if (this.fields.hasOwnProperty(key) && this.fields[key].name === name)Â {
                    return true;
                }
            }

            return false;
        }
    });
</script>