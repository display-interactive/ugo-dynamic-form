<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="ugo-field.html">

<dom-module id="ugo-dynamic-form">
    <template>
        <template id="fieldsContainer" is="dom-repeat" items="{{ fields }}" index-as="id">
            <div data-role="container" class$="[[ classes.container ]]">
                <label for$="[[ item.name ]]" class$="[[ classes.label ]]">[[item.label]]</label>
                <div class$="[[ getInputContainerClass(item) ]]">
                    <ugo-field
                            type="[[ item.type ]]"
                            class-name="[[ getInputClassSelector(item) ]]"
                            ident="[[ item.name ]]"
                            name="[[ item.name ]]"
                            value="{{ item.value }}"
                            required$="[[ item.required ]]"
                            pattern$="[[ item.pattern ]]"
                            width$="[[ item.width ]]"
                            options$="[[ item.options ]]"
                    ></ugo-field>
                </div>

                <template is="dom-if" if="{{!item.mandatory}}">
                    <div class$="[[ classes.removeContainer ]]">
                        <button type="button" data-id$="[[ item.name ]]" on-tap="removeField" class$="[[ classes.remove ]]">
                            {{ texts.remove }}
                        </button>
                    </div>
                </template>
            </div>
        </template>

        <div data-role="add" hidden$="[[!addAction]]">
            <chosen-decorator width="200">
                <select id="fieldType">
                    <template id="selectOption" is="dom-repeat" items="{{selectOptions}}" as="option" index-as="id">
                        <option value="[[option.value]]">[[option.label]]</option>
                    </template>
                </select>
            </chosen-decorator>
            <button type="button" class$="[[ classes.add ]]" on-tap="addField">{{texts.add}}</button>
        </div>
    </template>
</dom-module>
<script>
    Polymer({
        is: 'ugo-dynamic-form',

        /**
         * Default classes (bootstrap)
         */
        defaultClasses: {
            container: 'form-group',
            label: 'col-md-2 control-label',
            inputMandatoryContainer: 'col-md-10',
            inputContainer: 'col-md-9',
            removeContainer: 'col-md-1',
            input: 'form-control',
            checkbox: '',
            radio: '',
            remove: 'btn btn-default btn-danger pull-right',
            add: 'btn btn-default btn-success'
        },

        properties: {
            /**
             * Required
             */
            selector: {
                type: String
            },

            /**
             * Optionnal
             */
            config: {
                type: Object,
                value: {}
            },

            /**
             * Optionnal
             */
            classes: {
                type: Object,
                value: {}
            },

            /**
             * Optionnal
             */
            texts: {
                type: Object,
                value: {
                    add: '+',
                    remove: '-'
                }
            },

            /**
             * Internal
             */
            fields: {
                type: Array,
                value: [],
                readOnly: true
            },

            /**
             * Internal
             */
            selectOptions: {
                type: Array,
                value: [],
                readOnly: true
            },

            /**
             * Internal
             */
            data: {
                type: Object,
                value: {}
            },

            /**
             * Internal
             */
            addAction: {
                type: Boolean,
                value: true,
                readOnly: true
            }
        },

        listeners: {
            'dom-change': 'fetchData',
            'change': 'fetchData',
            'keyup': 'fetchData'
        },

        /**
         * @type {Boolean}
         */
        _fieldSetted: false,

        /**
         * @todo object merge for "classes" et "texts"
         * @todo add required and pattern to field
         * @todo add select in "type" choice config
         */
        ready: function() {
            this.input = document.querySelector(this.selector);
            if (this.input.value != '') {
                this.data = JSON.parse(this.input.value);
            }

            this.classes = this._mergeObjects(this.defaultClasses, this.classes);

            this._setAddAction(this._hasConfig());
            this._buildFields();
        },

        /**
         * Remove a field from the form
         */
        removeField: function(event) {
            var id = event.target.getAttribute('data-id');

            for(var index = 0; index < this.fields.length; index++) {
                if (this.fields[index].name == id && !this.fields[index].mandatory) {
                    this.splice('fields', index, 1);
                    break;
                }
            }

            this._buildSelectOptions();
            this.fetchData();
        },


        /**
         * Add a field to the form
         */
        addField: function() {
            var key = this.$.fieldType.value,
                type = this._getConfig('type', key)
            ;

            var newField = {
                name: key,
                type: type,
                label: this._getConfig('label', key),
                value: this._getFormValue(key),
                mandatory: this._getConfig('mandatory', key),
                required: this._getConfig('required', key),
                pattern: this._getConfig('pattern', key),
                options: this._getConfig('options', key),
                width: this._getConfig('width', key)
            };

            this.push('fields', newField);
            this._buildSelectOptions();
            this.fetchData();
        },

        /**
         * Fetch Data from the displayed fields
         */
        fetchData: function() {
            var children = this._getUgoFields();
            //true means that the rendering is finished
            if (this._isRendered()) {
                var data = {};
                [].forEach.call(children, function (ugoField) {
                    data[ugoField.ident] = ugoField.getFormattedValue();
                }.bind(this));

                this.data = data;
                this.input.value = JSON.stringify(data);
            }
        },

        /**
         * Get ugoFields in form
         *
         * @return {NodeList}
         * @private
         */
        _getUgoFields: function() {
            return Polymer.dom(this.root).querySelectorAll('div[data-role=container] ugo-field');
        },


        /**
         * Check if
         *
         * @return {Boolean}
         * @private
         */
        _isRendered: function() {
            var isRendered = true,
                children = this._getUgoFields();

            [].forEach.call(children, function (ugoField) {
                if (!ugoField.isRendered()) {
                    isRendered = false;
                }
            }.bind(this));

            return isRendered && children.length === this.fields.length;
        },

        /**
         * Build fields array for template
         */
        _buildFields: function () {
            var key,
                type,
                fields = [],
                rendered = [];

            //display preset data
            for (key in this.data) {
                if (this.data.hasOwnProperty(key)) {
                    rendered.push(key);
                    type = this._getConfig('type', key);
                    fields.push({
                        name: key,
                        type: type,
                        label: this._getConfig('label', key),
                        value: this._getFormValue(key),
                        mandatory: this._getConfig('mandatory', key),
                        required: this._getConfig('required', key),
                        pattern: this._getConfig('pattern', key),
                        width: this._getConfig('width', key),
                        options: this._getConfig('options', key)
                    });
                }
            }

            //display mandatory field with no preset data
            if (this._hasConfig()) {
                for (key in this.config) {
                    if  (
                        this.config.hasOwnProperty(key)
                        && this.config[key].mandatory
                        && rendered.indexOf(key) == -1
                    ) {
                        rendered.push(key);
                        fields.push({
                            name: key,
                            label: this._getConfig('label', key),
                            value: null,
                            type: this._getConfig('type', key),
                            mandatory: true,
                            required: this._getConfig('required', key),
                            pattern: this._getConfig('pattern', key),
                            width: this._getConfig('width', key),
                            options: this._getConfig('options', key)
                        })
                    }
                }
            }

            this._setFields(fields);
            this._buildSelectOptions();
        },

        /**
         * build select options
         *
         * depends from fields
         */
        _buildSelectOptions: function() {
            var options = [], key;
            if (this._hasConfig()) {
                for (key in this.config) {
                    if (this.config.hasOwnProperty(key) && !this._inField(key)) {
                        options.push({
                            value: key,
                            label: this._getConfig('label', key)
                        })
                    }
                }
            }

            this._setSelectOptions(options);
            this._setAddAction(options.length > 0);
        },

        /**
         * Check if config is setted
         *
         * @return {Boolean}
         */
        _hasConfig: function() {
            return Object.keys(this.config).length > 0;
        },

        /**
         * Get config
         * @param {String} type
         * @param {String} key
         * @private
         */
        _getConfig: function(type, key) {
            if (this._hasConfig() && this.config[key] != undefined && this.config[key][type] != undefined) {
                return this.config[key][type];
            }

            var defaultValue = null;
            switch (type) {
                case 'type':
                    defaultValue = 'text';
                    break;
                case 'mandatory': //if no config field is mandatory
                    defaultValue = !this._hasConfig();
                    break;
                case 'required': //if no config field is mandatory
                    defaultValue = false;
                    break;
                case 'pattern': //if no config field is mandatory
                    defaultValue = null;
                    break;
                case 'options': //if no config field is mandatory
                    defaultValue = [];
                    break;
                case 'width': //if no config field is mandatory
                    defaultValue = null;
                    break;
                case 'label':
                    defaultValue = key;
                    break;
            }

            return defaultValue;
        },

        /**
         * @param {String} name
         * @param {String} fieldType
         * @return {*}
         *
         * @private
         */
        _getFormValue: function(name) {
            var value = null;

            if (this.data[name] != undefined) {
                value = this.data[name];
            }

            return value;
        },

        /**
         * Used in template
         * @param {Object} item
         * @return {String}
         */
        getInputClassSelector: function (item) {
            var className = this.classes.input;
            switch (item.type) {
                case 'checkbox':
                    className = this.classes.checkbox;
                    break;
                case 'radio':
                    className = this.classes.radio;
                    break;
            }

            return className;
        },

        /**
         * Used in template
         * @param {Object} item
         * @return {String}
         */
        getInputContainerClass: function(item) {
            return item.mandatory ? this.classes.inputMandatoryContainer : this.classes.inputContainer;
        },

        /**
         * @param {String} name
         * @return {Boolean}
         * @private
         */
        _inField: function(name) {
            var key;
            /** @var {Array} this.fields */
            for (key in this.fields) {
                if (this.fields.hasOwnProperty(key) && this.fields[key].name === name) {
                    return true;
                }
            }

            return false;
        },

        /**
         * @return {Object|null}
         * @private
         */
        _getFieldByName: function(name) {
            var key;
            /** @var {Array} this.fields */
            for (key in this.fields) {
                if (this.fields.hasOwnProperty(key) && this.fields[key].name === name) {
                    return this.fields[key];
                }
            }

            return null;
        },

        /**
         * Merge 2 objets with just one level of depth
         *
         * @param obj1
         * @param obj2
         * @returns {{}}
         * @private
         */
        _mergeObjects: function (obj1, obj2) {
            var attr, result = {};
            for (attr in obj1) result[attr] = obj1[attr];
            for (attr in obj2) result[attr] = obj2[attr];

            return result;
        }
    });
</script>